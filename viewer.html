<!DOCTYPE html>
<html><meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <head><title>frwc Affinities</title>
  <script
   src="https://code.jquery.com/jquery-3.3.1.min.js"
   integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
   crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <!-- Formal data -->
  <script src='data/_traits.js'></script>
  <script src='data/_wizards.js'></script>
 </head>
<body><div id='main'></div></body>
<script>
/* Global variables */
frwc = {}
local = false

/* Default Options */
defaults = {
  navigatorKey    : 'wizard', //'positives',
  navigatorOptions: ['affinities','identities','positives','wizard'],

  // Sizing options
  samplerSize: 144,
  traitSize  : 87,
  informationWidth: 600,
  informationHeight: 230,

  // other options
  wizardDoubleClick: 'https://opensea.io/assets/0x521f9c7505005cfa19a8e5786a9c3c9c9f5e6f42/',
}

/* Load Sequence */
document.addEventListener("DOMContentLoaded", function(event) {   
  parseData()
  addCSS(cssRules)
  addCSS(commonNavigatorCSS)
  render()
  
  uxBehaviours()
  
  var p = $.when(1)
      p = p.then(function() { 
      
      }).then(function() {  
      
      })
})

parseData = function() {
  console.log(_traits)
  console.log(_wizards)
  /* Hash Maps */
  let hash = {background: 'backgrounds', body: 'bodies', familiar: 'familiars', head: 'heads', prop: 'props', rune: 'runes'}
   
  /* Output variables */
  let mapped = {traits:{}, traitTypes: {}, traitURLs:{}, identities:{}, positives:{}, affinities:{}}
  for (var key in hash) { mapped.traits[key] = {} }
  
  let names = {}
      names.wizards    = {}
      names.traits     = {}
      names.identities = {}
      names.positives  = {}
      names.affinities = {}

  let components = {}
      components.wizards    = {}
      components.identities = {}
      components.positives  = {}
      components.affinities = {}

  let identities  = {}
  let positives   = {}
  let memberships = {}

  for (let wizardID in _wizards) {
    let wizard = _wizards[wizardID]
     
    // Insert names for Wizards
    names.wizards[wizard.idx] = wizard.name
    // Generate space for this Wizard in memberships
    memberships[wizard.idx] = []
    // Generate the components list for a Wizard
    components.wizards[wizard.idx] = []
    
    for (var traitType in hash) {
      // Separate out the NO head/familiar/prop/rune types
      var n = wizard[traitType]
      var s = n == 7777 ? n + '-' + traitType : n
      
      components.wizards[wizard.idx].push([traitType, n])

      // Allocate Wizards into traits within trait categories that they belong to
      mapped.traits[traitType]    = mapped.traits[traitType]    || {}
      mapped.traits[traitType][s] = mapped.traits[traitType][s] || []
      if (mapped.traits[traitType][s].indexOf(wizard.idx) == -1) {
        mapped.traits[traitType][s].push(wizard.idx)
      }
      mapped.traitTypes[s] = mapped.traitTypes[n] || traitType

      mapped.traitURLs[traitType] = mapped.traitURLs[traitType]    || {}
      mapped.traitURLs[traitType][n] = generateTraitURL(n, traitType)
      // generate the URL
      
      // Allocate Wizards into Affinities that their traits grant them access to
      let traitAffinities = retrieveTrait(n) || null
      if (traitAffinities) {
        // Handle the Tag key
        traitAffinities.tags.forEach(function(identity, _) {
          // Add the list for this Tag to our "mapped" Object
          if (!mapped.identities[identity.idx]) {
            if (typeof identities[identity.idx] == 'undefined') { identities[identity.idx] = clone(identity) }
            mapped.identities[identity.idx] = []
            // Also map the name of this Affinity to our "names" Object
            names.identities[identity.idx] = identity.name
            names.affinities[identity.idx] = identity.name
          }
          // Add Wizard to this Tag if not included
          if (mapped.identities[identity.idx].indexOf(wizard.idx) == -1) {
            mapped.identities[identity.idx].push(wizard.idx)
          }
          // Add Membership to this Wizard and record the part
          if (typeof memberships[wizard.idx][identity.idx] == 'undefined') {
            memberships[wizard.idx][identity.idx] = {}
          }
          memberships[wizard.idx][identity.idx][traitType] = n
          // Add this Wizard to the Emergent if not included
          mapped.affinities[identity.idx] = mapped.affinities[identity.idx] || {}
          mapped.affinities[identity.idx]['identities'] = mapped.affinities[identity.idx]['identities'] || []
          if (mapped.affinities[identity.idx]['identities'].indexOf(wizard.idx) == -1) {
            mapped.affinities[identity.idx]['identities'].push(wizard.idx)
          }
          // Also add this to the components list and add the ID if not present
          // Tags
          components.identities[identity.idx] = components.identities[identity.idx] || []
          if (components.identities[identity.idx].indexOf(traitAffinities.idx) == -1) {
            components.identities[identity.idx].push(traitAffinities.idx)
          }
          // Emergent:Tags
          components.affinities[identity.idx] = components.affinities[identity.idx] || {}
          components.affinities[identity.idx]['identities'] = components.affinities[identity.idx]['identities'] || []
          if (components.affinities[identity.idx]['identities'].indexOf(traitAffinities.idx) == -1) {
            components.affinities[identity.idx]['identities'].push(traitAffinities.idx)
          }
          // Emergent:Trait Type
          components.affinities[identity.idx][traitType] = components.affinities[identity.idx][traitType] || {}
          if (typeof components.affinities[identity.idx][traitType][n] == 'undefined') {
            components.affinities[identity.idx][traitType][n] = 'i'
          } else if (components.affinities[identity.idx][traitType][n] == 'p') {
            components.affinities[identity.idx][traitType][n] = 'ip'
          }
        })
        // Handle the Affinity key
        traitAffinities.affinity.forEach(function(positive, _) {
          // Add the list for this Affinity to our "mapped" Object
          if (!mapped.positives[positive.idx]) {
            if (typeof positives[positive.idx] == 'undefined') { positives[positive.idx] = clone(positive) }
            mapped.positives[positive.idx] = []
            // Also map the name of this Affinity to our "names" Object
            names.positives[positive.idx] = positive.name
            names.affinities[positive.idx] = positive.name
          }
          // Add Wizard to this Affinity if not included
          if (mapped.positives[positive.idx].indexOf(wizard.idx) == -1) {
            mapped.positives[positive.idx].push(wizard.idx)
          }
          // Add Membership to this Wizard and record the part
          if (typeof memberships[wizard.idx][positive.idx] == 'undefined') {
            memberships[wizard.idx][positive.idx] = {}
          }
          memberships[wizard.idx][positive.idx][traitType] = n
          // Add this Wizard to the Emergent if not included
          mapped.affinities[positive.idx] = mapped.affinities[positive.idx] || {}
          mapped.affinities[positive.idx]['positives'] = mapped.affinities[positive.idx]['positives'] || []
          if (mapped.affinities[positive.idx]['positives'].indexOf(wizard.idx) == -1) {
            mapped.affinities[positive.idx]['positives'].push(wizard.idx)
          }
          // Also add this to the components list and add the ID if not present
          // Affinities
          components.positives[positive.idx] = components.positives[positive.idx] || []
          if (components.positives[positive.idx].indexOf(traitAffinities.idx) == -1) {
            components.positives[positive.idx].push(traitAffinities.idx)
          }
          // Emergent:Affinities
          components.affinities[positive.idx] = components.affinities[positive.idx] || {}
          components.affinities[positive.idx]['positives'] = components.affinities[positive.idx]['positives'] || []
          if (components.affinities[positive.idx]['positives'].indexOf(traitAffinities.idx) == -1) {
            components.affinities[positive.idx]['positives'].push(traitAffinities.idx)
          }
          // Emergent:Trait Type
          components.affinities[positive.idx][traitType] = components.affinities[positive.idx][traitType] || {}
          if (typeof components.affinities[positive.idx][traitType][n] == 'undefined') {
            components.affinities[positive.idx][traitType][n] = 'p'
          } else if (components.affinities[positive.idx][traitType][n] == 'i') {
            components.affinities[positive.idx][traitType][n] = 'ip'
          }
        })
        // Also add in the name
        names.traits[traitAffinities.idx] = traitAffinities.displayName
      } else {
        // console.log(n)
      }
    }
  }
  for (let affinityID in mapped.affinities) {
    let identities = mapped.affinities[affinityID].identities || []
    let positives  = mapped.affinities[affinityID].positives  || []

    let merged = [...identities, ...positives]

    for (var i = 0; i < merged.length; ++i) {
      for (var j = i+1; j < merged.length; ++j) {
        if (merged[i] === merged[j])
          merged.splice(j--, 1)
      }
    }
    mapped.affinities[affinityID].merged = merged.sort(function(a, b) { return a - b })
  }

  let list = ['head', 'body', 'prop', 'familiar', 'rune']
  let denominator = 10000
  probabilities = {}
  for (var affinityID in names.affinities) {
    let name = names.affinities[affinityID]
    probabilities[affinityID] = {
      name: name,
      1: {},
      2: {},
      3: {},
      4: {},
      5: {},
      head: {},
      body: {},
      prop: {},
      familiar: {},
      rune: {},
    }
    var c = components.affinities[affinityID]
    list.forEach(function(item, _) {
      if (typeof c[item] != 'undefined') {
        for (var k in c[item]) {
          probabilities[affinityID][item][k] = {}
          probabilities[affinityID][item][k]['affinity-chance'] = mapped.traits[item][k].length / denominator
          probabilities[affinityID][item][k]['identity-chance'] = mapped.identities[k] ? mapped.identities[k].length / denominator : 0
          probabilities[affinityID][item][k]['positive-chance'] = mapped.positives[k] ? mapped.positives[k].length / denominator : 0 
        }
        
      }
    })
  }
  mapped.probabilities = probabilities

  
  frwc = mapped
  frwc._referenceWizards = _wizards
  frwc._referenceTraits  = _traits
  frwc._names   = names
  frwc._components = components
  frwc._memberships = memberships

  console.log(frwc)
  // console.log(identities)
}

render = function() {
  addCSS(navigatorCSS)
  
  /* Draw navigator element */
  const navigator = document.createElement('div')
        navigator.setAttribute('id', 'navigator')
  document.body.appendChild(navigator)
  
  addNavigatorElements()
  
  let filterCSS = ` /* Filter CSS */
    #filter {
      position: fixed;
      left    : 50%;
      top     : 50%;
      min-height: 670px;
      min-width : 800px;
      transform : translate(-50%, -50%);
      background: rgba(255,255,255,0.23);
      backdrop-filter: blur(9px);
      border-radius  : 8px;
    }
  `
  addCSS(filterCSS)

  /* Draw Filter window */
}

addWizardSearchToNavigator = function() {
  $('#navigator-input input')
     .attr('placeholder','input wizard ID here')
     .on('change', function(e, v) {
       addWizardToNavigator(e.target.value)
     })
}

addWizardToNavigator = function(id) {
  // Check ID is valid
  if (!id) { 
    console.log('No valid ID provided #1.')
    $('#navigator-input input').attr('placeholder','no wizard ID provided')
    return
  }
  let name = frwc._names.wizards[id]
  if (!name) {
    console.log('No valid ID provided #2.')
    $('#navigator-input input').attr('placeholder','wizard ID provided not discoverable')
    return
  }
  console.log(name)
  let memberships = frwc._memberships[id]
  let list       = {}
  let components = {}
  let affinities = {}
  for (var affinityID in memberships) {
    list[affinityID]       = frwc._names.affinities[affinityID]
    components[affinityID] = frwc._components.affinities[affinityID]
    affinities[affinityID] = frwc.affinities[affinityID]
  }

  $('#navigator-head').empty()
  $('#navigator-panel')
     .empty()
  addElementsToNavigator('affinity', list, components, affinities)
  
  // Add the name of the Wizard
  // Add the picture of the Wizard
  // Add the affinities of the Wizard  

  
}

addElementsToNavigator = function(tag, list, componentsList, membersList) {
  let output   = ''
  let ordering = ['head','body','prop','familiar','rune']
  let sortableElements = Object.values(list).map((x, i) => [x, Object.keys(list)[i]])
  sortableElements.sort()
  sortableElements.forEach(function(item, _) {
    let name = item[0]
    let id   = item[1]
    let e    = ''
    e += '<div class="panel-item ' + tag + '" id="' + tag + '-' + id + '"'
    e += ' onclick="renderObject(' + id + ', \'' + tag + '\')">'
    e += name + '<span class="mute">#' + id + '</span> '
    e += '<span class="mute">('
    
    let f = componentsList[id]
    ordering.forEach(function(trait, _) {
      e += f[trait] ? Object.keys(f[trait]).length : 0
      if (_ < ordering.length - 1) { e += '/' }
    })
    if (tag == 'affinity') {
      e += '/' + membersList[id].merged.length + ') </div>'
    } else {
      e += '/' + membersList[id].length + ') </div>'
    }
    
    /* Filter check here */
    
    output += e
  })
  $('#navigator-panel').append(output)
  let prefix = tag
  switch(tag) {
    case 'identity': prefix = 'Identities'; break;
    case 'positive': prefix = 'Positives' ; break;
    case 'affinity': prefix = 'Affinities'; break;
  }
  $('#navigator-head')
    .append(prefix + ' <span class="mute">[</span>' + sortableElements.length + '<span class="mute">] (H/B/P/F/R/#)</span>')
}

/* Used by renderIdentity(), renderAffinity(), renderPositive() */
renderElement = function(ordering, componentsList, urlList) {
  let output = ''
  let padCount = Math.floor(370 / defaults.traitSize)
  
  /* A little bit of UX magic here to be able to scroll to the last element and place it at 1st position */
  let w = window.innerWidth - $('#navigator').width()
  let c = Math.floor(w / defaults.traitSize) - 1 + 1
  
  ordering.forEach(function(component, _) {
    output += '<div id="scroller-' + component + '" class="scroller-wrapper"><div class="scroller ' + component + '">'
    for (var i = 0; i < padCount; i++) {
      output += '<div class="trait empty"></div>'
    }
    let elements = componentsList[component]
    let urls = urlList[component]
    for (let componentID in elements) {
      let e = ''
      let url = urls[componentID]
      let isp = elements[componentID]
      let p = 'p'
      let i = 'i'
      if (isp == 'p') { i = '' } else if (isp == 'i') { p = '' }
      e += '<div id="trait-' + componentID + '" class="trait" style="background-image:url(\'' + url + '\')">'
      e += '<div class="is-positive ' + p + '">+</div><div class="is-identity ' + i + '">I</div></div>'
      output += e
    }
    for (var i = 0; i < c; i++) {
      output += '<div class="trait empty"></div>'
    }
    output += '</div></div>'
  })
  return output
}

renderWizardSampler = function(members, count) {
  let id = $('#navigator-input input').val()
  console.log(id)
  let sample = getRandomWizards(members, count ? count : 7, id)
  console.log(sample)

  let n = Math.floor(370 / defaults.traitSize) - 1

  /* A little bit of UX magic here to be able to scroll to the last element and place it at 1st position */
  let w = window.innerWidth - $('#navigator').width()
  let c = Math.floor(w / defaults.samplerSize) - 1 + 1
  
  let d = ''
  d += '<div id="wizard-container"><div id="wizard-sampler">'
  for (var i = 0; i < n; i++) {
    d += '<div class="wizard-sample empty"></div>'
  }
  sample.forEach(function(wizard, _) {
    let c = frwc._components.wizards[wizard]
    d += '<div id="wizard-' + wizard + '" class="wizard-sample">'
    c.forEach(function(component, i) {
      let uri = frwc.traitURLs[component[0]][component[1]]
      d += '<div class="wizard-sample-component ' + component[0] + '" '
      if (uri) { d += 'style="background-image:url(\'' + uri + '\')"' }
      d += '></div>'
    })
    d += '</div>'
  })
  for (var i = 0; i < c; i++) {
    d += '<div class="wizard-sample empty"></div>'
  }
  d += '</div></div>'
  return d
}

renderIdentity = function(id) {
  console.log('Rendering identity (' + id + ')')
  // Highlight it in the Navigator
  $('.identity.active').removeClass('active')
  $('#identity-' + id).addClass('active')
  
  $('.scrollerCSS').remove()
  addCSS(scrollerCSS, '#main', 'scrollerCSS')

  let identityComponents = frwc._components.affinities[id]
  let componentURLs      = frwc.traitURLs
  let identityMembers    = frwc.identities[id]
  
  let sortBy = ['head','body','prop','familiar','rune']
  let d = ''

  d += renderElement(sortBy, identityComponents, frwc.traitURLs)
  d += renderWizardSampler(identityMembers, 7)
  $('#main-content').append(d)
  $('body').trigger('new-samplers')
  document.getElementById('wizard-sampler').scrollTop = 77
}

renderPositive = function(id) {
  console.log('Rendering positive (' + id + ')')
  // Highlight it in the Navigator
  $('.positive.active').removeClass('active')
  $('#positive-' + id).addClass('active')
  
  $('.scrollerCSS').remove()
  addCSS(scrollerCSS, '#main', 'scrollerCSS')

  let positiveComponents = frwc._components.affinities[id]
  let componentURLs      = frwc.traitURLs
  let positiveMembers    = frwc.positives[id]
  
  let sortBy = ['head','body','prop','familiar','rune']
  let d = ''

  d += renderElement(sortBy, positiveComponents, frwc.traitURLs)
  d += renderWizardSampler(positiveMembers, 7)
  $('#main-content').append(d)
  $('body').trigger('new-samplers')
  document.getElementById('wizard-sampler').scrollTop = 77
}
 
renderAffinity = function(id) {
  console.log('Rendering affinity (' + id + ')')
  // Highlight it in the Navigator
  $('.affinity.active').removeClass('active')
  $('#affinity-' + id).addClass('active')
  
  $('.scrollerCSS').remove()
  addCSS(scrollerCSS, '#main', 'scrollerCSS') // lets you adjust the scroller view per element-type

  let affinityComponents = frwc._components.affinities[id]
  let componentURLs      = frwc.traitURLs
  let affinityMembers    = frwc.affinities[id].merged
  
  let sortBy = ['head','body','prop','familiar','rune']
  let d = ''
  
  d += renderElement(sortBy, affinityComponents, frwc.traitURLs)
  d += renderWizardSampler(affinityMembers, 7)
  $('#main-content').append(d)
  $('body').trigger('new-samplers')
  document.getElementById('wizard-sampler').scrollTop = 77

  let wizardID = $('#navigator-input input').val()
  if (wizardID != '' && typeof frwc._referenceWizards[wizardID] != 'undefined') {
    renderWizard(wizardID)
  }
}

/* Routers */
addNavigatorElements = function(key) {
  var key = key || defaults.navigatorKey
  
  // Prepare the panel
  $('#navigator').empty().append('<div id="navigator-head" class="' + key + '"></div><div id="navigator-panel"></div>')
  $('#navigator-input input')
     .attr('placeholder','')
     .off('change')
  addCommonNavigatorElements()

  switch(key) {
    case 'identities':
      addElementsToNavigator('identity', frwc._names.identities, frwc._components.affinities, frwc.identities)
      break;
    case 'positives':
      addElementsToNavigator('positive', frwc._names.positives, frwc._components.affinities, frwc.positives)
      break;
    case 'affinities':
      addElementsToNavigator('affinity', frwc._names.affinities, frwc._components.affinities, frwc.affinities)
      break;
    case 'wizard':
      addWizardSearchToNavigator('wizard')
      break;
  }
}
renderObject = function(id, type) {
  $("#main *:not(#navigator, #navigator *, #navigator-return, #navigator-return > div, #navigator-left, #navigator-right)").remove()
  renderCommonMainElements()
  switch(type) {
    case 'identity':
      renderIdentity(id)
      break;
    case 'positive':
      renderPositive(id)
      break;
    case 'affinity':
      renderAffinity(id)
      break;
  }
}

inspectWizard = function(wizardID) {
  if (!wizardID) { return false }
  let wizard = frwc._components.wizards[wizardID]
  let w = {}
  for (var part in wizard) {
    w[wizard[part][0]] = wizard[part][1]
  }
  console.log(w)
  let output = []
  for (var affinityID in frwc.affinities) {
    let members = frwc.affinities[affinityID]
    let o = {}
    let m = members.merged
    let c = frwc._components.affinities[affinityID]
    if (m.indexOf(wizardID) != -1) {
      for (var part in w) {
        if (typeof c[part] != 'undefined' && typeof c[part][w[part]] != 'undefined') {
          o[part] = [w[part], c[part][w[part]]]
        }
      }
      output.push([frwc._names.affinities[affinityID], frwc._components.affinities[affinityID], o])
      console.log(frwc._names.affinities[affinityID])
      // console.log(frwc._components.affinities[affinityID])
      console.log(o)
    }
  }
  return output
}

renderWizard = function(id) {
      // Remove previous modifications so they persist even when not hovering over the Wizard
      $('.trait.i').removeClass('i')
      $('.trait.p').removeClass('p')
      $('.trait.ip').removeClass('ip')
      $('.wizard-sample').removeClass('highlighted')
      // Reset all positions of scrollers
      $('.scroller').scrollTop(0)
      
      let wizard = frwc._referenceWizards[id]

      // Prep the information preface
      let d = ''
      d += '<div id="information-left">'
      d += '<br/>'

      let traits  = ['head', 'body', 'prop', 'familiar', 'rune']
      let hash    = {affinity: 'affinities', identity: 'identities', positive: 'positives'}

      let element = $('.panel-item.active').attr('id')
          element = element.split('-')
      let elementType  = element[0]
      let elementID    = element[1]

      var components;
      if (elementType == 'affinity') {
        components = frwc._components[hash[elementType]][elementID]
      } else {
        components = frwc._components['affinities'][elementID]
      }

      let traitNames   = frwc._names.traits
      let traitMembers = frwc.traits

      traits.forEach(function(trait, _) {
        let isMemberOfElement = false
        // Highlight the wizard's traits that belong to the Element
        if (components[trait] && components[trait][wizard[trait]]) {
          let type = components[trait][wizard[trait]]
          let traitDiv = $('#trait-' + wizard[trait])
          traitDiv.addClass(type)
            
          // Now we want to move this to 1st position by scrolling
          document.querySelector('.scroller.' + trait).scrollTop = (12 + (traitDiv.index() - 1) * (87 + 3)) - Math.floor(360/94) * 94

          // For use in the information constructor
          isMemberOfElement = type
        }	

        // Include data into the information sheet
        d += '<div class="information-subclass-1">' + trait.substring(0, 1).toUpperCase() + trait.substring(1, trait.length) + ':</div>'
        d += '<div class="information-subclass-2 ' + (isMemberOfElement ? isMemberOfElement : '') + '">'
        if (traitNames[wizard[trait]]) {
          d += traitNames[wizard[trait]].substring(0,26).padEnd(26,' ')
          d += '</div><div class="information-subclass-3">'
          d += ' ' + typeof traitMembers[trait][wizard[trait]] != 'undefined' ? (traitMembers[trait][wizard[trait]].length / 100).toFixed(2) + '%' : ''
          d += '</div>'
        } else {
          d += '-</div>'
        }
        d += '<br/>'
         
      })

      // Complete the information sheet
      d += '</div>'
      d += '<div id="information-right">'
      d += '</div>'
      $('#information-content').empty().append(d)
      $('#information-header').empty().append(wizard.name + '<span class="mute">#' + wizard.idx + '</span>')
      $('#information').css('opacity','1')
      
      // Make some visual changes to the selected wizard
      $('#wizard-' + id).addClass('highlighted')

      // Update the footer
      $('#information-footer-content').empty().append('<i>Double click the picture to go buy the Wizard.</i>')
}

/* UI/UX Functions */
resetNavigatorPosition = function() { document.getElementById('navigator').scrollTop = 0 }

addCommonNavigatorElements = function() {
  $('#navigator-left').remove()
  $('#navigator-right').remove()
  $('#navigator-return').remove()
  $('#navigator-input').remove()

  /* Add navigator arrows */
  let d = ''
  d += '<div id="navigator-left" onclick="switchNavigator(\'left\')"></div>'
  d += '<div id="navigator-right" onclick="switchNavigator(\'right\')"></div>'
  /* Add navigator filter */
  d += '<div id="navigator-input"><input dir="rtl"></input></div>'
  $('body').append(d)

  /* Add a ReturnToTop arrow */
  $('body').append('<div id="navigator-return" class="invisible" onclick="resetNavigatorPosition()"><div>&uarr;</div></div>')
  $('#navigator').off('scroll').on('scroll', function(e) {
    
    if (document.getElementById(e.target.id).scrollTop > 89) {
      if (document.getElementById('navigator-return').className == 'invisible') {
        $('#navigator-return').removeClass('invisible')
      }
      if (document.getElementById('navigator-left').className != 'invisible') {
        $('#navigator-left').addClass('invisible')
        $('#navigator-right').addClass('invisible')
      }
    } else {
      if (document.getElementById('navigator-return').className != 'invisible') {
        $('#navigator-return').addClass('invisible')
      }
      if (document.getElementById('navigator-left').className == 'invisible') {
        $('#navigator-left').removeClass('invisible')
        $('#navigator-right').removeClass('invisible')
      }
    }
  })
}
renderCommonMainElements = function() {
  /* https://codepen.io/dances-with-bears/pen/inlwc */
  addCSS(`
@import url('https://fonts.googleapis.com/css2?family=Syne+Mono&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Xanh+Mono&display=swap');

#information {
  position: absolute;
  width: ${defaults.informationWidth}px;
  height: calc(${defaults.informationHeight}px + 37px);
  left  : calc(360px + 7px);
  top   : calc(5 * (${defaults.traitSize}px + 0.6em) + 1.1 * ${defaults.samplerSize}px);
  background: rgba( 255, 255, 255, 0.13 );
  border-radius: 6px;
  backdrop-filter: blur(6px);

font-family: 'Arimo',monospace;
font-size  : 11pt;
color : rgba( 44, 44, 44, 1 );
color : rgba( 171, 171, 171, 1 );
   }
#information-header {
 font-size: 16pt;
 padding-top: 0.2em;
 padding-bottom: 0.2em;
  height: 37px;
  text-align:center;
  line-height: calc(37px);
}
#information-content {
  position: absolute;
  width: 100%;
  height: calc(${defaults.informationHeight}px - 37px);
  background: rgba( 255, 255, 255, 0.06 );
}
#information-left {
  position: absolute;
  width: 63%;
  padding-left: 0.3em;
  top : 0%;

  height: calc(100%);
  border-right: 1px solid rgba(255,255,255,0.15);
}
#information-right {
  position: absolute;
  left: 63%;
  top: 0%;
  height: calc(100%); 
}
#information-footer {
  position: absolute;
  top: calc(${defaults.informationHeight}px);
  width: 100%;
  font-size: 9pt;
  line-height: 44px;
text-align:center;
color : rgba( 171, 171, 171, 0.55 );
}
  `)

  let d = ''
  d += '<div id="main-content">'
  d += '<div id="information">'
  d +=  '<div id="information-header"><div id="information-header-label"></div></div>'
  d +=  '<div id="information-content"><div id="information-content-left"></div><div id="information-content-right"></div></div>'
  d +=  '<div id="information-footer"><div id="information-footer-content"></div></div>'
  d += '</div>'
  d += '</div>'
  $('#main').append(d)

  
}
uxBehaviours = function() {
  addCSS(`
.information-subclass-1, .information-subclass-2, .information-subclass-3 {
  display: inline-block;
  line-height: 1.6em;
}
.information-subclass-1 {
  width: 90px;
}
.information-subclass-2 {
  width: 210px;
}
.information-subclass-2.i {
  color: rgba(0, 112, 221, 1);
}
.information-subclass-2.p {
  color: rgba(236, 63, 168, 1);
}
.information-subclass-2.ip {
  color: rgba(255, 128, 0, 1);
}
.information-subclass-3 {
  
}
`)

  // Eventify up the samplers
  $('body').off('new-samplers').on('new-samplers', function() {
    // Update the information board
    $('.wizard-sample:not(.empty)').on('mouseenter', function(e, v) {
      let id = e.currentTarget.id.replace('wizard-','')
      renderWizard(id)
      
    }).on('mouseleave', function(e,v) {
      
    }).on('dblclick', function(e,v) {
    
      let id = e.currentTarget.id.replace('wizard-','')
      let win = window.open(defaults.wizardDoubleClick + id, '_blank')
      win.focus()
      
    })
     
  })

}
switchNavigator = function(dir) { /* Figure out where we are first */
  let key = document.getElementById('navigator-head').className
  let menu = defaults.navigatorOptions
  
  let nextKey = menu.indexOf(key)
  if (nextKey == -1) {
    nextKey = 0
  } else if (dir == 'right') {
    if (nextKey >= menu.length - 1) {
      nextKey = 0
    } else {
      nextKey++
    }
  } else if (dir == 'left') {
    if (nextKey <= 0) {
      nextKey = menu.length - 1
    } else {
      nextKey--
    }
  }
  let nextElement = menu[nextKey]
  addNavigatorElements(nextElement)
}

/* Helper Functions */
generateTraitURL = function(traitID, traitType) {
  let trait  = retrieveTrait(traitID)
  if (!trait) { return false }
  
  let commas = /,/g
  let dots   = /\./g
  let spaces = /\s+/g
  let qualified = trait.displayName.trim()
                       .replace(':','')
                       .replace("'",'')
                       .replace(commas,'')
                       .replace(dots,'')
                       .replace(spaces,'-')
                       .toLowerCase()
  if (qualified == 'jewled-hummingbird') {
    qualified = 'jewelled-hummingbird'
  } else if (qualified == 'tengu-preist') {
    qualified = 'tengu-priest'
  } else if (qualified == 'vile-of-virgins-blood') {
    qualified = 'vial-of-virgins-blood'
  }
  let traitMap = {head: 'heads', body: 'bodies', prop: 'props', familiar: 'familiars', rune: 'runes', background: 'backgrounds'}
  let uri = traitMap[traitType] + '/' + (traitType != 'rune' ? traitType + '-' : '') + qualified + '-400.png'
  if (local) { uri = 'components/' + uri }
  return uri
}
getRandomWizards = function(array, count, proto) {
  let len = array.length, taken = new Array(len);
  if (count > len) { count = len }
  let result = new Array(count)
  let wizard = frwc._referenceWizards[proto] || false
  while (count--) {
    let x = Math.floor(Math.random() * len)
    let y = array[x in taken ? taken[x] : x]
    if (wizard) {
      if (y != proto) {
        result[count] = y
        taken[x] = --len in taken ? taken[len] : len
      }
    } else {
      result[count] = array[x in taken ? taken[x] : x]
      taken[x] = --len in taken ? taken[len] : len
    }
  }
  if (wizard) {
    result.unshift(proto)
    result.pop()
  }
  return result
}
raiseEvent = function(eventName, data) { document.body.dispatchEvent(new Event(eventName, {'data': data})) }
retrieveTrait = function(traitID) {
  for (var t in _traits) {
    if (_traits[t].idx == traitID) { return _traits[t] }
  }
  return false
}
sortObject = function(arr) { return Object.fromEntries(Object.entries(arr).sort()) }

/* Utility Functions */
clone = function(obj) {
    var copy;
    if (null == obj || 'object' != typeof obj) { return obj }
    if (obj instanceof String) { return (' ' + obj).slice(1) } // https://stackoverflow.com/a/31733628
    if (obj instanceof Date) { 
      copy = new Date()
      copy.setTime(obj.getTime())
      return copy }
    if (obj instanceof Array) {
      copy = []
      for (var i = 0, len = obj.length; i < len; i++) { copy[i] = clone(obj[i]) }
      return copy }
    if (obj instanceof Object) {
      copy = {}
      for (var attr in obj) { if (obj.hasOwnProperty(attr)) { copy[attr] = clone(obj[attr]) } }
      return copy }
    throw new Error('Unable to copy object! Type not supported.') }
    
addCSS = function(rule, container, ruleIdentifier) {
  let rc = ruleIdentifier ? ruleIdentifier : 'FRWC-CSS'
  let output = '<div class="' + rc + '">&shy;<style>' + rule + '</style></div>'
  document.querySelectorAll(rc).forEach(e => e.remove())
  if (container) {
    document.querySelector(container).insertAdjacentHTML('beforeend', output)
  } else {
    document.body.insertAdjacentHTML('beforeend', output)
  } }

/* CSS Rules */
cssRules = `
@import url('https://fonts.googleapis.com/css2?family=Neucha&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Arimo&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Yaldevi:wght@300&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap');

.FRWC-CSS { display:none; } /* CSS Rules */
html, body {
  padding    : 0px;
  margin     : 0px;
  height     : 100%;
}
body {
  display         : flex;
  flex-direction  : column;
  background: linear-gradient(-27deg, #0c375c, #311f4d, #3b1f40, #311f4d);
  background-size: 400% 400%;
  animation: gradient 15s ease infinite;
  height: 100vh;
  overflow-y: hidden;
}
body::-webkit-scrollbar {
  display:none;
  width: 0;
  background: transparent;
}
body::-webkit-scrollbar-thumb {
  background: #FF0000;
}

@keyframes gradient {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}
#main {
  flex           : 1;
  display        : flex;
  flex-direction : column;
  align-items    : center;
  display        : inline-block;
  white-space    : pre-wrap;
  font-family    : 'Neucha', cursive;
  font-size      : 15pt;
  z-index        : 3;
  overflow-y : hidden;
}
#main-content {
  position:relative;
  width: 100%;
  height: 100%;
  overflow: scroll;
}

#main-content::-webkit-scrollbar {
    width: 12px;
    height: 12px;
    display:none;
    visibility:hidden;
}
#main-content::-webkit-scrollbar-track {
    background: white;
}
#main-content::-webkit-scrollbar-thumb {
    background: #ddd;
    visibility:hidden;
}
#main-content:hover::-webkit-scrollbar-thumb {
    visibility:visible;
}
`
commonNavigatorCSS = ` /* Navigator Common Elements CSS */
  #navigator-left, #navigator-right {
    position: absolute;
    width: 0; 
    height: 0; 
    z-index: 13;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent; 
    top: calc((34px + 0.4em + 0.4em)/2);
    transform: translate( 0%, -50% );
    cursor:pointer;
    transition: all 130ms;
  }
  #navigator-left {
    border-right:10px solid rgba( 1, 1, 1, 0.16 ); 
    border-right:10px solid rgba( 188, 177, 199, 0.13 );
    left: 7px;
  }
  #navigator-right {
    border-left:10px solid rgba( 188, 177, 199, 0.13 );
    left: calc(360px - 7px - 10px);
  }
  #navigator-left:hover {
    border-right:10px solid rgba( 188, 188, 199, 0.56 ); 
  }
  #navigator-right:hover {
    border-left:10px solid rgba( 188, 177, 199, 0.56 );
  }
  
  #navigator-return.invisible, #navigator-left.invisible, #navigator-right.invisible {
    display      : none;
    opacity      : 0;
  }
  
  #navigator-return {
    position     : fixed; 
    bottom       : 0%;
    left         : calc(360px + 0.1ch);
    z-index      : 13;
    
    width        : 3ch;
    height       : 3ch;
    border       : 1px solid rgba(255,255,255,0.04);
    border-radius: 6px;
    background   : rgba( 255, 255, 255, 0.02 );
    
    font-family  : 'Yaldevi';
    text-align   : center;
    line-height  : 3.2ch;
    cursor       : pointer;
  }
  #navigator-return div {
    transition   : all 230ms;
    background   : -webkit-linear-gradient(rgba(44, 44, 44, 1), rgba(167, 167, 167, 1), rgba(133, 133, 133, 1));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  #navigator-return:hover {
    border       : 1px solid rgba( 255, 255, 255, 0.09 );
    background   : rgba( 1, 1, 1, 0.04 );
  }
  #navigator-return:hover div {
    background   : -webkit-linear-gradient(rgba(114, 114, 114, 1), rgba(255, 255, 255, 0.88));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  #navigator-input {
    position: absolute;
    left: calc(32px);
    width: calc(360px - 34px - 34px);
    height: 30px; 
    z-index: 13;
    top: calc((34px + 0.4em + 0.4em)/2);
    cursor:pointer;
    transform: translate( 0%, -50% );
  }
  #navigator-input input {
    position: relative;
    width: 100%;
    height: 100%;
    border: 1px solid rgba( 255, 1, 1, 0 );
    border-bottom: 1px solid rgba( 255, 255, 255, 0.03 );
    outline: none;
    background: rgba(0,0,0,0);
    transition: all 130ms;
    font-family  : 'Arimo', serif;
    font-size    : 13pt;
    color       : rgba( 211, 211, 211, 0.77 );
  }
  #navigator-input input:hover {
    border-bottom: 1px solid rgba( 255, 255, 255, 0.14 );
  }
  #navigator-input input:focus {
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(3px);
    border-bottom: 1px solid rgba( 255, 255, 255, 0.33 );
  }
`

navigatorCSS = ` /* Navigator CSS */
  #navigator {
    position: absolute;
    left: 0%;
    top : 0%;
    height: 100%;
    width : 360px;
    overflow-y : scroll;
    font-family: 'Arimo';
    background  : rgba( 188, 188, 188, 0.04 );
    backdrop-filter: blur(7px);
    z-index: 5;
  }
  #navigator::-webkit-scrollbar {
    display:none;
    width: 0;
    background: transparent;
  }
  #navigator::-webkit-scrollbar-thumb {
    background: #FF0000;
  }
  .mobile > #navigator {
    position: absolute;
    left : 0%;
    top  : 0%;
    height: 210px;
    width : 100%;
  }
  /* For later use */
  #navigator-panel {
    position    : relative;
  }
  #navigator-head, .panel-item.identity, .panel-item.positive, .panel-item.affinity {
    width       : calc(100% - 1.9em);
    height      : 34px;
    padding-top   : 0.4em;
    padding-bottom: 0.4em;
    padding-right : 0.3em;
    padding-left  : 1.6em;
    line-height : 34px;
    font-size   : 13pt;
    color       : rgba( 211, 211, 211, 0.77 );
  }
  #navigator-head {
    position    : fixed;
    display     : block;
    background  : rgba( 1, 1, 1, 0.21 );
  }
  .panel-item.identity, .panel-item.positive, .panel-item.affinity {
    position    : relative;
    top         : calc(34px + 0.8em);
    display     : block;
    cursor      : pointer;
    user-select : none;
  }
  #navigator-head .mute, .panel-item.identity .mute, .panel-item.positive .mute, .panel-item.affinity .mute {
    color       : rgba( 211, 211, 211, 0.12 );
  }
  .panel-item.identity:hover, .panel-item.positive:hover, .panel-item.affinity:hover {
    background  : rgba( 201, 201, 201, 0.24 );
  }
  
  .identity.active, .positive.active, .affinity.active {
    background  : rgba( 201, 201, 201, 0.18 );
  }
`
scrollerCSS = ` /* Scroller CSS */
  .scrollerCSS {display: none;}
  .scroller-wrapper {
    position: inherit;
    height: ${defaults.traitSize}px;
    border: 2px solid rgba(255,255,255,0);
  }
  .scroller {
    position  : inherit;
    width     : ${defaults.traitSize}px;
    height    : ${window.innerWidth}px;
    overflow-y: auto;
    overflow-x: hidden;
    transform : rotate(-90deg) translateY(-${defaults.traitSize}px);
    transform-origin: right top;
    border: 1px solid rgba(1,1,1,0);
  }
  .scroller::-webkit-scrollbar {
    display   : none;
    background: rgba(0,0,0,0);
  }
  .trait {
    position: relative;
    width : ${defaults.traitSize}px;
    height: ${defaults.traitSize}px;
    margin-top: 3px;
    margin-bottom : 3px;
    transform : rotate(90deg) translateX(${defaults.traitSize}px);
    transform-origin: right top;
    
    background-size: cover;
    background-repeat: no-repeat;
    
    cursor: pointer;
    border-radius: 5px;
  }
  .trait:not(.empty) {
    background-color: rgba( 1, 1, 1, 0.067 );
    transition: all 230ms;
  }
  .trait:not(.empty):hover {
    background-color: rgba( 255, 255, 255, 0.012 );
  }
  .trait div {
    position : relative;
    font-size: 9pt;
    color    : rgba( 255, 255, 255, 0.012 );
  }
  .trait .is-positive {
    position: absolute;
    top     : 4px;
    left    : 6px;
  }
  .trait .is-identity {
    position: absolute;
    bottom  : 4px;
    right   : 6px;
  }
  .trait .is-positive.p {
    color   : rgba( 255, 255, 255, 0.23 );
  }
  .trait .is-identity.i {
    color   : rgba( 255, 255, 255, 0.23 );
  }
  .trait.i {
    background-color: rgba( 0, 112, 221, 0.21 );
  }
  .trait.p {
    background-color: rgba( 236, 63, 168, 0.21 );
  }
  .trait.ip {
    background-color: rgba(255, 128, 0, 0.21 );
  }
  
  #wizard-container {
    position: inherit;
    margin-top: 15px;
    height: ${defaults.traitSize}px;
  }
  #wizard-sampler {
    position  : inherit;
    width     : ${defaults.samplerSize}px;
    height    : ${window.innerWidth}px;
    overflow-y: auto;
    overflow-x: hidden;
    transform : rotate(-90deg) translateY(-${defaults.samplerSize}px);
    transform-origin: right top;
  }
  .wizard-sample {
    position: relative;
    width : ${defaults.samplerSize}px;
    height: ${defaults.samplerSize}px;
    margin-top: 3px;
    margin-bottom : 3px;
    transform : rotate(90deg) translateX(${defaults.samplerSize}px);
    transform-origin: right top;
    cursor: pointer;
    border-radius: 6px;
  }
  .wizard-sample-component {
    position: absolute;
    left: 0%;
    top : 0%;
    width : ${defaults.samplerSize}px;
    height: ${defaults.samplerSize}px;
    
    background-size: cover !important;
    background: transparent;
    background-repeat: no-repeat;
    background-position: center;
    border-radius: 6px;
    
  }
  .wizard-sample-component.background {
    filter  : alpha(opacity=1);
    opacity : 0.35;
  }
  .wizard-sample.empty {
  
  }
  .wizard-sample.highlighted .wizard-sample-component.background {
    opacity : 1.0;
  }
  #wizard-sampler::-webkit-scrollbar {
    display   : none;
    background: rgba(0,0,0,0);
  }
`

</script>
</html>
